<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CherrySwap挖矿自动复投_OK链挖矿自动复投_DeFi挖矿自动复投 - ofarm</title>
    <meta name="applicable-device" content="pc,mobile">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    <meta name="keywords" content="自动复投,CHE自动复投,CherrySwap自动复投,Ok链自动复投">
    <meta name="description"
          content="ofarm为用户提供CherrySwap无限复投机枪池。数字资产挖矿利润复投，稳稳地收益DEFI，流动性挖矿，Ok链生态等。是目前Oklink挖CHE最潮流的白嫖方式，同时是当下市场是最稳的投资热点细分领域。">
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<header class="page-header">
    <div class="row">
        <div class="logo">
            <a href="/" title="ofarm">
                <img src="./image/ic_logo.png" alt="ofarm">
            </a>
        </div>
        <div class="menu">
            <div id="ConnectBtn">连接钱包</div>
            <div id="WalletFeature" style="display: none"></div>
        </div>
    </div>
</header>
<div class="introduce">
    <div class="row">
        <h1>Cherryswap挖矿复投池</h1>
        <p>ofarm提供Cherryswap挖矿复投池，在复投池存入虚拟币挖矿产出的收益自动复投进池内，不断累积质押数，达到更好的投资效益。</p>
    </div>
</div>
<div class="list">
    <div class="loading" style="display: none">
        <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="60px" height="60px"
             viewBox="0 0 50 50" style="enable-background:new 0 0 50 50" xml:space="preserve">
                <path fill="#2C6FFF"
                      d="M25.251,6.461c-10.318,0-18.683,8.365-18.683,18.683h4.068c0-8.071,6.543-14.615,14.615-14.615V6.461z"
                      transform="rotate(275.098 25 25)">
                    <animateTransform attributeType="xml" attributeName="transform" type="rotate" from="0 25 25"
                                      to="360 25 25" dur="0.6s" repeatCount="indefinite"></animateTransform>
                </path>
            </svg>
    </div>
    <div id="PoolList">
        <div class="pool-item" data-pool="pool0">
            <div class="tit">
                <div class="pic-info">
                    <img src="image/tokens/CHE.svg" class="token-pic-main">
                </div>
                <div>
                    <div class="main-text symbol-replace">CHE</div>
                    <div class="sub-text">
                        存 <span class="symbol-replace">CHE</span> 赚取 <span class="symbol-replace">CHE</span>
                    </div>
                </div>
            </div>
            <div class="earn-info">
                <div class="amount-text">
                    <div class="earn-amount">0.000</div>
                    <div class="tooltip">未提取收益(<span class="symbol-replace">CHE</span>)</div>
                </div>
            </div>
            <div class="actions">
                <div class="actions-item long approve-btn" style="display: none">批准 <span
                        class="symbol-replace">CHE</span>
                </div>
                <div class="actions-item long unlock-btn">解锁钱包</div>
                <div class="actions-item withdraw-btn" style="display: none">取回 <span class="symbol-replace">CHE</span>
                </div>
                <div class="actions-item deposit-btn" style="display: none">存入 <span class="symbol-replace">CHE</span>
                </div>
            </div>
            <div class="profit-info">
                <div class="item">
                    <div class="val apr" style="color: #FFAF67">0.000%</div>
                    <div class="tit">年化</div>
                </div>
                <div class="item">
                    <div class="val my-deposit">0.000</div>
                    <div class="tit">我的质押</div>
                </div>
            </div>
            <div class="pool-info">
                <div class="item">
                    <div class="val total_deposit">0.000</div>
                    <div class="tit"><span>总量</span>
                        <div class="check-pool">在 Oklink 上查看</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="pool-item" data-pool="pool1">
            <div class="tit">
                <div class="pic-info">
                    <img src="./image/tokens/USDT.svg" class="token-pic-main">
                </div>
                <div>
                    <div class="main-text symbol-replace">USDT</div>
                    <div class="sub-text">
                        存 <span class="symbol-replace">USDT</span> 赚取 <span class="symbol-replace">USDT</span>
                    </div>
                </div>
            </div>
            <div class="earn-info">
                <div class="amount-text">
                    <div class="earn-amount">0.000</div>
                    <div class="tooltip">未提取收益(<span class="symbol-replace">USDT</span>)</div>
                </div>
            </div>
            <div class="actions">
                <div class="actions-item long approve-btn" style="display: none">批准 <span
                        class="symbol-replace">USDT</span>
                </div>
                <div class="actions-item long unlock-btn">解锁钱包</div>
                <div class="actions-item withdraw-btn" style="display: none">取回 <span class="symbol-replace">USDT</span>
                </div>
                <div class="actions-item deposit-btn" style="display: none">存入 <span class="symbol-replace">USDT</span>
                </div>
            </div>
            <div class="profit-info">
                <div class="item">
                    <div class="val apr" style="color: #FFAF67">0.000%</div>
                    <div class="tit">年化</div>
                </div>
                <div class="item">
                    <div class="val my-deposit">0.000</div>
                    <div class="tit">我的质押</div>
                </div>
            </div>
            <div class="pool-info">
                <div class="item">
                    <div class="val total_deposit">0.000</div>
                    <div class="tit"><span>总量</span>
                        <div class="check-pool">在 Oklink 上查看</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="pool-item" data-pool="pool2">
            <div class="tit">
                <div class="pic-info">
                    <img src="./image/tokens/BTCK.svg" class="token-pic-main">
                </div>
                <div>
                    <div class="main-text symbol-replace">BTCK</div>
                    <div class="sub-text">
                        存 <span class="symbol-replace">BTCK</span> 赚取 <span class="symbol-replace">BTCK</span>
                    </div>
                </div>
            </div>
            <div class="earn-info">
                <div class="amount-text">
                    <div class="earn-amount">0.000</div>
                    <div class="tooltip">未提取收益(<span class="symbol-replace">BTCK</span>)</div>
                </div>
            </div>
            <div class="actions">
                <div class="actions-item long approve-btn" style="display: none">批准 <span
                        class="symbol-replace">BTCK</span>
                </div>
                <div class="actions-item long unlock-btn">解锁钱包</div>
                <div class="actions-item withdraw-btn" style="display: none">取回 <span class="symbol-replace">BTCK</span>
                </div>
                <div class="actions-item deposit-btn" style="display: none">存入 <span class="symbol-replace">BTCK</span>
                </div>
            </div>
            <div class="profit-info">
                <div class="item">
                    <div class="val apr" style="color: #FFAF67">0.000%</div>
                    <div class="tit">年化</div>
                </div>
                <div class="item">
                    <div class="val my-deposit">0.000</div>
                    <div class="tit">我的质押</div>
                </div>
            </div>
            <div class="pool-info">
                <div class="item">
                    <div class="val total_deposit">0.000</div>
                    <div class="tit"><span>总量</span>
                        <div class="check-pool">在 Oklink 上查看</div>
                    </div>
                </div>
            </div>
        </div>
        <div class="pool-item" data-pool="pool3">
            <div class="tit">
                <div class="pic-info">
                    <img src="./image/tokens/ETHK.svg" class="token-pic-main">
                </div>
                <div>
                    <div class="main-text symbol-replace">BTCK</div>
                    <div class="sub-text">
                        存 <span class="symbol-replace">BTCK</span> 赚取 <span class="symbol-replace">ETHK</span>
                    </div>
                </div>
            </div>
            <div class="earn-info">
                <div class="amount-text">
                    <div class="earn-amount">0.000</div>
                    <div class="tooltip">未提取收益(<span class="symbol-replace">ETHK</span>)</div>
                </div>
            </div>
            <div class="actions">
                <div class="actions-item long approve-btn" style="display: none">批准 <span
                        class="symbol-replace">ETHK</span>
                </div>
                <div class="actions-item long unlock-btn">解锁钱包</div>
                <div class="actions-item withdraw-btn" style="display: none">取回 <span class="symbol-replace">ETHK</span>
                </div>
                <div class="actions-item deposit-btn" style="display: none">存入 <span class="symbol-replace">ETHK</span>
                </div>
            </div>
            <div class="profit-info">
                <div class="item">
                    <div class="val apr" style="color: #FFAF67">0.000%</div>
                    <div class="tit">年化</div>
                </div>
                <div class="item">
                    <div class="val my-deposit">0.000</div>
                    <div class="tit">我的质押</div>
                </div>
            </div>
            <div class="pool-info">
                <div class="item">
                    <div class="val total_deposit">0.000</div>
                    <div class="tit"><span>总量</span>
                        <div class="check-pool">在 Oklink 上查看</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div class="pool-item-seed" data-pool="">
    <div class="tit">
        <div class="pic-info">
            <img src="image/tokens/CHE.svg" class="token-pic-main">
        </div>
        <div>
            <div class="main-text symbol-replace">CHE</div>
            <div class="sub-text">
                存 <span class="symbol-replace">CHE</span> 赚取 <span class="symbol-replace">CHE</span>
            </div>
        </div>
    </div>
    <div class="earn-info">
        <div class="amount-text">
            <div class="earn-amount">0.000</div>
            <div class="tooltip">未提取收益(<span class="symbol-replace">CHE</span>)</div>
        </div>
    </div>
    <div class="actions">
        <div class="actions-item long approve-btn" style="display: none">批准 <span class="symbol-replace">CHE</span>
        </div>
        <div class="actions-item long unlock-btn">解锁钱包</div>
        <div class="actions-item withdraw-btn" style="display: none">取回 <span class="symbol-replace">CHE</span>
        </div>
        <div class="actions-item deposit-btn" style="display: none">存入 <span class="symbol-replace">CHE</span></div>
    </div>
    <div class="profit-info">
        <div class="item">
            <div class="val apr" style="color: #FFAF67">0.000%</div>
            <div class="tit">年化</div>
        </div>
        <div class="item">
            <div class="val my-deposit">0.000</div>
            <div class="tit">我的质押</div>
        </div>
    </div>
    <div class="pool-info">
        <div class="item">
            <div class="val total_deposit">0.000</div>
            <div class="tit"><span>总量</span>
                <div class="check-pool">在 Oklink 上查看</div>
            </div>
        </div>
    </div>
</div>
<div id="SelectWallet">
    <div class="sell"></div>
    <div class="content-box">
        <div id="Metamask" class="wallet-item">
            <img src="./image/metamask.png">
            <span>MetaMask</span>
        </div>
        <div id="Walletconnect" class="wallet-item">
            <img src="./image/walletconnect.png">
            <span>WalletConnect</span>
        </div>
    </div>
</div>
<div id="WalletInfo">
    <div class="sell"></div>
    <div class="content-box">
        <div class="tit">我的钱包</div>
        <div class="account">
            <div class="connect-info">
                <div class="info">已连接 MetaMask</div>
                <div class="actions">
                    <div class="action-btn disconnect">断开</div>
                    <div class="action-btn change-wallet">更改</div>
                </div>
            </div>
            <div class="address-info">
                <div id="IdenticonBig"></div>
                <div class="address" data-address=""></div>
            </div>
            <div class="other-action">
                <div class="action-btn copy-address">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                        <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
                    </svg>
                    <span>复制</span></div>
                <div class="action-btn go-to-explorer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                         stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                        <polyline points="15 3 21 3 21 9"></polyline>
                        <line x1="10" y1="14" x2="21" y2="3"></line>
                    </svg>
                    <span>区块浏览器</span>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="WithdrawAction">
    <div class="shell"></div>
    <div class="content-box">
        <div class="tit">取出 <span class="symbol-main">CHE</span></div>
        <div class="input-file">
            <input type="text" class="num_input" inputmode="decimal" title="Token Amount" autocomplete="off"
                   autocorrect="off" pattern="^[0-9]*[.,]?[0-9]*$" placeholder="0.0" spellcheck="false">
            <div class="input-max">全部</div>
        </div>
        <div class="show-max">可用 <span class="max-amount">123123</span></div>
        <div class="actions">
            <div class="actions-item cancel">取消</div>
            <div class="actions-item ok">确定</div>
        </div>
    </div>
</div>
<div id="DepositAction">
    <div class="shell"></div>
    <div class="content-box">
        <div class="tit">存入 <span class="symbol-main">CHE</span></div>
        <div class="input-file">
            <input type="text" class="num_input" inputmode="decimal" title="Token Amount" autocomplete="off"
                   autocorrect="off" pattern="^[0-9]*[.,]?[0-9]*$" placeholder="0.0" spellcheck="false">
            <div class="input-max">全部</div>
        </div>
        <div class="show-max">可用 <span class="max-amount">123123</span></div>
        <div class="approve-info">批准 <span class="approve-amount">123123</span></div>
        <div class="actions">
            <div class="actions-item cancel">取消</div>
            <div class="actions-item ok">确定</div>
            <div class="actions-item approve" style="display: none">批准</div>
        </div>
    </div>
</div>
<footer class="pager-footer">
    <div class="row">
        <div class="media">
            <a href="https://twitter.com/ofarm_finance" title="Twitter" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="19.504" viewBox="0 0 24 19.504">
                    <path id="ic_twitter"
                          d="M24,4.557a9.831,9.831,0,0,1-2.828.775,4.932,4.932,0,0,0,2.165-2.724A9.864,9.864,0,0,1,20.21,3.8a4.927,4.927,0,0,0-8.391,4.49A13.978,13.978,0,0,1,1.671,3.149,4.93,4.93,0,0,0,3.194,9.723,4.9,4.9,0,0,1,.965,9.107,4.927,4.927,0,0,0,4.914,14a4.935,4.935,0,0,1-2.224.084A4.928,4.928,0,0,0,7.29,17.5,9.9,9.9,0,0,1,0,19.54a13.939,13.939,0,0,0,7.548,2.212A13.925,13.925,0,0,0,21.543,7.106,10.025,10.025,0,0,0,24,4.557Z"
                          transform="translate(0 -2.248)" fill="rgba(255,255,255,0.9)"/>
                </svg>
            </a>
            <a href="https://t.me/ofarmfinance" title="Telegram" target="_blank">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="20" viewBox="0 0 24 20">
                    <path id="ic_telegram"
                          d="M18.384,22.779a1.189,1.189,0,0,0,1.107.145,1.16,1.16,0,0,0,.724-.84C21.084,18,23.192,7.663,23.983,3.948a.781.781,0,0,0-.26-.758.8.8,0,0,0-.8-.14C18.733,4.6,5.82,9.447.542,11.4a.822.822,0,0,0,.051,1.563c2.367.708,5.474,1.693,5.474,1.693s1.452,4.385,2.209,6.615a.876.876,0,0,0,.6.576.866.866,0,0,0,.811-.207l3.1-2.923s3.572,2.619,5.6,4.062ZM7.374,14.1,9.053,19.64l.373-3.507L19.611,6.947a.277.277,0,0,0,.033-.377.284.284,0,0,0-.376-.064L7.374,14.1Z"
                          transform="translate(0 -3)" fill="rgba(255,255,255,0.9)" fill-rule="evenodd"/>
                </svg>
            </a>
        </div>
        <div class="flink">
            <a href="http://tokencreater.com/" target="_blank">Token Creater</a>
            <a href="https://www.uniswap123.com/" target="_blank">Uniswap123</a>
        </div>
    </div>
</footer>
</body>
<script src="js/metamask-onboarding.bundle.js"></script>
<script src="js/walletconnect.min.js"></script>
<script src="js/bignumber.min.js"></script>
<script src="js/jazzicon.min.js"></script>
<script src="js/web3.min.js"></script>
<script src="js/config.js"></script>
<script>

    var connectState = false;
    var factoryAddress = '0x2b6c5fFe2Ce8124B56cffB1D3f5469C7b188425C';
    var rpc = 'https://exchainrpc.okex.org';
    var approveMax = '115792089237316195423570985008687907853269984665640564039457584007913129639935'

    function checkPoolForUser(pid, poolInfo) {
        if (!connectState) {
            return
        }
        var wallet = document.querySelector('[data-address]').getAttribute('data-address');
        getTokenAllowance(pid, poolInfo['token'], wallet, function (res, pid) {
            getPoolBalance(pid, wallet, function (res2, pid) {
                console.log('[Allowance]', res);
                console.log('[Balance]', res2);
                var dom = document.querySelector('.pool-item[data-pool=pool' + pid + ']');
                if (res === '0' && res2.amount === '0') {
                    dom.querySelector('.withdraw-btn').style.display = 'none';
                    dom.querySelector('.deposit-btn').style.display = 'none';
                    dom.querySelector('.approve-btn').style.display = 'block';
                } else {
                    dom.querySelector('.withdraw-btn').style.display = 'block';
                    dom.querySelector('.deposit-btn').style.display = 'block';
                    dom.querySelector('.approve-btn').style.display = 'none';
                }
                if (res2.amount === '0') {
                    dom.querySelector('.withdraw-btn').setAttribute('class', 'actions-item withdraw-btn disabled');
                    dom.querySelector('.my-deposit').innerText = '0.000';
                } else {
                    dom.querySelector('.withdraw-btn').setAttribute('class', 'actions-item withdraw-btn');
                    dom.querySelector('.my-deposit').innerText = tokenAmount(res2.amount);
                }
                if (res2.pendingReward === '0') {
                    dom.querySelector('.earn-amount').innerText = '0.000';
                } else {
                    dom.querySelector('.earn-amount').innerText = tokenAmount(res2.pendingReward);
                }
            })
        })
    }

    function tokenAmount(wei) {
        if (wei === 0 || wei === '0') {
            return '0.000'
        } else {
            var bn = new BigNumber(wei);
            var etherNum = bn.dividedBy(1e18);
            if (etherNum.isLessThan(0.000001)) {
                return '<0.000001'
            }
            if (etherNum.isGreaterThanOrEqualTo(1000)) {
                return etherNum.toFormat(2, 1)
            } else if (etherNum.isGreaterThanOrEqualTo(1)) {
                return etherNum.toFormat(3, 1)
            } else {
                return etherNum.toFormat(6, 1)
            }
        }
    }

    function getTokenBalance(tokenAddress, wallet, cb) {
        var web3 = new Web3(window.provider);
        var coin = new web3.eth.Contract(window.abis.token, tokenAddress);
        coin.methods.balanceOf(wallet).call().then(function (res) {
            if (cb) {
                cb(res, tokenAddress)
            }
        });
    }

    function getUserPendingTx() {
        var wallet = document.querySelector('#WalletInfo .address-info .address').getAttribute('data-address');
        if (connectState) {
            var web3 = new Web3(rpc);
            web3.eth.getPendingTransactions().then(function (tx_list) {
                for (var i = 0; i < tx_list; i++) {
                    if (tx_list[i]['from'] === wallet) {
                        document.querySelector('#WalletFeature').innerText = 'Pending';
                    }
                }
                setTimeout(getUserPendingTx, 1000);
            })
        } else {
            setTimeout(getUserPendingTx, 1000);
        }
    }

    function getPoolBalance(pid, wallet, cb) {
        var web3 = new Web3(rpc);
        var coin = new web3.eth.Contract(window.abis.factory, factoryAddress);
        coin.methods.userInfo(pid, wallet).call().then(function (res) {
            if (cb) {
                cb(res, pid);
            }
        });
    }

    function getPoolProfitRate(poolId, cb) {
        var web3 = new Web3(rpc);
        var factory = new web3.eth.Contract(window.abis.factory, factoryAddress);
        factory.methods.statistics(poolId).call()
            .then(function (res) {
                if (cb) {
                    cb(res, poolId);
                }
            });
    }

    function getTokenAllowance(pid, tokenAddress, wallet, cb) {
        var web3 = new Web3(rpc);
        var coin = new web3.eth.Contract(window.abis.token, tokenAddress);
        coin.methods.allowance(wallet, factoryAddress).call().then(function (res) {
            console.log('allowance', res)
            if (cb) {
                cb(res, pid)
            }
        });
    }

    function withdrawToken() {
        if (!connectState) {
            return
        }
        var web3 = new Web3(window.provider);
        var amount = document.querySelector('#WithdrawAction .num_input').value;
        var pid = document.querySelector('#WithdrawAction').getAttribute('data-poolid');
        var factory = new web3.eth.Contract(window.abis.factory, factoryAddress);
        var amount_wei = new BigNumber(amount).multipliedBy(1e18);
        var max_amount = document.querySelector('#WithdrawAction .input-max').getAttribute('data-max');
        if (amount_wei.isGreaterThan(max_amount)) {
            showTips('error', '取出数量超过上限');
            return
        }
        var wallet = document.querySelector('#WalletInfo .address-info .address').getAttribute('data-address');
        if (amount_wei.isEqualTo(max_amount)) {
            factory.methods.withdrawAll(Number(pid))
                .send({
                    from: wallet,
                    gas: 600000
                })
                .on('transactionHash', function (hash) {
                    console.log('[withdrawToken]transactionHash:', hash);
                    showTips('info', 'transactionHash:' + hash)
                    document.querySelector('#WithdrawAction').style.display = 'none';
                })
                .on('error', function (error) {
                    console.error(error)
                    if (error.code === 4001 || error === '用户取消了操作') {
                        showTips('error', '取出失败，用户主动取消操作。')
                    } else {
                        showTips('error', '取出失败，请检查是否有足够Gas。')
                    }
                })
                .then(function (res) {
                    getPool(function (id, pool_info) {
                        checkPoolForUser(id, pool_info);
                    })
                    showTips('success', '取出成功');
                }, true)
        } else {
            factory.methods.withdraw(Number(pid), amount_wei.valueOf())
                .send({
                    from: wallet,
                    gas: 600000
                })
                .on('transactionHash', function (hash) {
                    console.log('[withdrawToken]transactionHash:', hash);
                    showTips('info', 'transactionHash:' + hash)
                    document.querySelector('#WithdrawAction').style.display = 'none';
                })
                .on('error', function (error) {
                    console.error(error)
                    if (error.code === 4001 || error === '用户取消了操作') {
                        showTips('error', '取出失败，用户主动取消操作。')
                    } else {
                        showTips('error', '取出失败，请检查是否有足够Gas。')
                    }
                })
                .then(function (res) {
                    getPool(function (id, pool_info) {
                        checkPoolForUser(id, pool_info);
                    })
                    showTips('success', '取出成功');
                }, true)
        }
    }

    function depositToken() {
        if (!connectState) {
            return
        }
        var web3 = new Web3(window.provider);
        var amount = document.querySelector('#DepositAction .num_input').value;
        var pid = document.querySelector('#DepositAction').getAttribute('data-poolid');
        var factory = new web3.eth.Contract(window.abis.factory, factoryAddress);
        var amount_wei = new BigNumber(amount).multipliedBy(1e18);
        var wallet = document.querySelector('#WalletInfo .address-info .address').getAttribute('data-address');
        factory.methods.deposit(Number(pid), amount_wei.valueOf())
            .send({
                from: wallet,
                gas: 600000
            })
            .on('transactionHash', function (hash) {
                console.log('[withdrawToken]transactionHash:', hash);
                showTips('info', 'transactionHash:' + hash);
                document.querySelector('#DepositAction').style.display = 'none';
            })
            .on('error', function (error) {
                console.error(error)
                if (error.code === 4001 || error === '用户取消了操作') {
                    showTips('error', '取出失败，用户主动取消操作。')
                } else {
                    showTips('error', '存入失败，请检查是否有足够Gas。')
                }
            })
            .then(function (res) {
                getPool(function (id, poolInfo) {
                    checkPoolForUser(id, poolInfo);
                }, true)
                showTips('success', '存入成功');
            }, true)
    }

    function getPool(cb, ifUpdate) {
        console.log('[ofram]update all pool');
        var web3 = new Web3(rpc);
        var factory = new web3.eth.Contract(window.abis.factory, factoryAddress);
        for (var i in window.pool_info) {
            factory.methods.poolInfo(Number(i)).call()
                .then(function (res) {
                    console.log('...res', res)
                    var id = getPidFromPoolInfo(res);
                    window.pool_info[id]['totalDeposit'] = res['totalDeposit']
                    window.pool_info[id]['pendingReward'] = res['pendingReward']
                    buildPoolItem(id, window.pool_info[id], true);
                    if (cb) {
                        cb(id, res)
                    }
                })
        }
    }

    function getPidFromPoolInfo(res) {
        for (var i in window.pool_info) {
            if (res['token'] === window.pool_info[i]['token']) {
                return i
            }
        }
        return -1
    }

    function buildPoolItem(pid, pool_info, ifUpdate) {
        document.querySelector('.loading').style.display = 'none';
        var dom
        if (ifUpdate) {
            dom = document.querySelector('.pool-item[data-pool=pool' + pid + ']');
        } else {
            dom = document.querySelector('.pool-item-seed').cloneNode(true);
        }
        dom.setAttribute('data-pool', 'pool' + pid.toString());
        dom.setAttribute('class', 'pool-item');
        dom.querySelector('.token-pic-main').setAttribute('src', './image/tokens/' + window.tokens[pool_info['token']] + '.svg');
        dom.querySelector('.total_deposit').innerHTML = tokenAmount(new BigNumber(pool_info['totalDeposit']).plus(pool_info['pendingReward']).valueOf());
        if (!ifUpdate) {
            dom.querySelector('.approve-btn').onclick = function () {
                if (!window.connectState) {
                    toggleSelectWindow()
                } else {
                    approveToken(pid, pool_info['token'])
                }
            };
            dom.querySelector('.check-pool').onclick = function () {
                window.open("https://www.oklink.com/okexchain/address/0x79858A822668E7E1FAa62f7aef8Ad260C042a6de");
            };
            dom.querySelector('.withdraw-btn').onclick = function () {
                toggleWithdrawWindow(pid)
            };
            dom.querySelector('.deposit-btn').onclick = function () {
                toggleDepositWindow(pid)
            };
            dom.querySelector('.unlock-btn').onclick = toggleSelectWindow;
        }

        var mainSymbol = dom.querySelectorAll('.symbol-replace');
        for (var i = 0; i < mainSymbol.length; i++) {
            mainSymbol[i].innerText = window.tokens[pool_info['token']];
        }
        var box = document.querySelector('#PoolList');
        if (!ifUpdate) {
            box.appendChild(dom);
        }
        getPoolProfitRate(pid, function (res, poolId) {
            var dom = document.querySelector('.pool-item[data-pool=pool' + poolId + ']');
            if (res.share === '0') {
                dom.querySelector('.apr').innerText = '0.000%';
            } else {
                var share = res.share / 1e12;
                var a = 1 / (res.time / (365 * 86400)) * share * 100;
                var profitRate = new BigNumber(1).dividedBy(res.time / (365 * 86400)).multipliedBy(res.share).dividedBy(1e12).multipliedBy(100);
                dom.querySelector('.apr').innerText = profitRate.toFixed(3) + '%';
            }
        })
    }

    function copyText(string) {
        var text = string;
        var oInput = document.createElement('input');
        oInput.value = text;
        document.body.appendChild(oInput);
        oInput.select(); // 选择对象
        document.execCommand('Copy'); // 执行浏览器复制命令
        oInput.className = 'oInput';
        document.querySelector('body').removeChild(oInput);
        showTips('info', '地址已经复制');
    }

    function goToExplorer(address) {
        if (address) {
            window.open("https://www.oklink.com/okexchain/address/" + address);
        } else {
            address = document.querySelector('[data-address]').getAttribute('data-address');
            console.log(address)
            if (address) {
                window.open("https://www.oklink.com/okexchain/address/" + address);
            }
        }
    }

    function showTips(type, string) {
        var dom = document.createElement('div');
        dom.setAttribute('class', 'global-tips hide ' + type);
        dom.innerHTML = string;

        var box = document.querySelector('.global-tips-box');
        if (box) {
            box.appendChild(dom);

        } else {
            box = document.createElement('div');
            box.setAttribute('class', 'global-tips-box');
            document.querySelector('body').appendChild(box);
            box.appendChild(dom);
        }
        setTimeout(function () {
            dom.setAttribute('class', 'global-tips ' + type);
        }, 10)
        setTimeout(function () {
            dom.setAttribute('class', 'global-tips hide ' + type);
            setTimeout(function () {
                box.removeChild(dom)
            }, 300)
        }, 4000)
    }

    function copyAddress() {
        var string = document.querySelector('[data-address]').getAttribute('data-address');
        copyText(string);
    }

    function approveToken(pid, tokenAddress, cb, amount) {
        if (!connectState) {
            toggleSelectWindow();
        }
        var web3 = new Web3(window.provider);
        var coin = new web3.eth.Contract(window.abis.token, tokenAddress);
        var wallet = document.querySelector('#WalletInfo .address-info .address').getAttribute('data-address');
        var dom = document.querySelector('.pool-item[data-pool=pool' + pid + ']');
        coin.methods.approve(factoryAddress, amount ? amount : approveMax)
            .send({from: wallet})
            .on('transactionHash', function (hash) {
                console.log('[approveToken]transactionHash:', hash);
                showTips('info', 'transactionHash:' + hash)
            })
            .on('error', function (error) {
                console.error(error)
                if (error.code === 4001 || error === '用户取消了操作') {
                    showTips('error', '批准失败，用户主动取消操作。')
                } else {
                    showTips('error', '批准失败，请检查是否有足够Gas。')
                }
            })
            .then(function (res) {
                showTips('success', '批准成功');
                dom.querySelector('.withdraw-btn').style.display = 'block';
                dom.querySelector('.deposit-btn').style.display = 'block';
                dom.querySelector('.approve-btn').style.display = 'none';
                if (cb) {
                    cb(web3.utils.toWei('100000000', 'ether'))
                }
            })
    }

    function getIdenticon(address, size) {
        var addr = address.slice(2, 10)
        var seed = parseInt(addr, 16);
        return jazzicon(size, seed);
    }

    function showAddress(address) {
        var begin = address.substring(0, 6);
        var end = address.substring(38, 42);
        return begin + '...' + end
    }

    function toggleSelectWindow() {
        document.getElementById('WalletInfo').style.display = 'none';
        var SelectWalletWindow = document.getElementById('SelectWallet');
        SelectWalletWindow.style.display = SelectWalletWindow.style.display === 'block' ? 'none' : 'block';
    }

    function toggleWalletInfoWindow() {
        document.getElementById('SelectWallet').style.display = 'none';
        var WalletInfoWindow = document.getElementById('WalletInfo');
        WalletInfoWindow.style.display = WalletInfoWindow.style.display === 'block' ? 'none' : 'block';
    }

    function toggleWithdrawWindow(poolId) {
        var dom = document.getElementById('WithdrawAction');
        if (dom.style.display === 'block') {
            dom.style.display = 'none';
        } else {
            window.input_history = '';
            dom.setAttribute('data-poolid', poolId);
            var symbol = window.tokens[window.pool_info[poolId]['token']];
            dom.querySelector('.symbol-main').innerText = symbol;
            dom.querySelector('.num_input').value = '';
            dom.querySelector('.ok').setAttribute('class', 'actions-item ok disabled');
            dom.querySelector('.input-max').setAttribute('data-max', '0');
            dom.querySelector('.max-amount').innerText = 0;
            dom.style.display = 'block';
            var wallet = document.querySelector('#WalletInfo .address-info .address').getAttribute('data-address');
            getPoolBalance(poolId, wallet, function (res, poolAddress) {
                var dom = document.querySelector('.pool-item[data-pool=pool' + poolAddress + ']');
                if (res.amount === '0') {
                    dom.querySelector('.withdraw-btn').setAttribute('class', 'actions-item withdraw-btn disabled');
                    dom.querySelector('.my-deposit').innerText = '0.000';
                } else {
                    dom.querySelector('.withdraw-btn').setAttribute('class', 'actions-item withdraw-btn');
                    dom.querySelector('.my-deposit').innerText = tokenAmount(res.amount);
                    document.querySelector('#WithdrawAction .input-max').setAttribute('data-max', res.amount);
                    document.querySelector('#WithdrawAction .max-amount').innerText = new BigNumber(res.amount).dividedBy(1e18).toFormat();
                }
                if (res.pendingReward === '0') {
                    dom.querySelector('.earn-amount').innerText = '0.000';
                } else {
                    dom.querySelector('.earn-amount').innerText = tokenAmount(res.pendingReward);
                }
            })
        }
    }

    function toggleDepositWindow(poolId) {
        var dom = document.getElementById('DepositAction');
        if (dom.style.display === 'block') {
            dom.style.display = 'none';
        } else {
            window.input_history = '';
            dom.setAttribute('data-poolid', poolId);
            var symbol = window.tokens[window.pool_info[poolId]['token']];
            dom.querySelector('.symbol-main').innerText = symbol;
            dom.querySelector('.num_input').value = '';
            dom.querySelector('.ok').setAttribute('class', 'actions-item ok disabled');
            dom.querySelector('.approve').innerText = '批准';
            dom.querySelector('.input-max').setAttribute('data-max', '0');
            dom.querySelector('.max-amount').innerText = 0;
            dom.style.display = 'block';
            var wallet = document.querySelector('#WalletInfo .address-info .address').getAttribute('data-address');
            getTokenAllowance(poolId, window.pool_info[poolId]['token'], wallet, function (res, pid) {
                if (res === '0') {
                    dom.querySelector('.actions-item.ok').style.display = 'none'
                    dom.querySelector('.actions-item.approve').style.display = 'block'
                } else {
                    dom.querySelector('.actions-item.ok').style.display = 'block'
                    dom.querySelector('.actions-item.approve').style.display = 'none'
                }
                dom.querySelector('.input-max').setAttribute('data-approve-amount', res);
                getTokenBalance(window.pool_info[pid]['token'], wallet, function (res2, tokenAddress) {
                    console.log('[getTokenBalance]', res2)
                    dom.querySelector('.max-amount').innerText = new BigNumber(res2).dividedBy(1e18).toFormat();
                    dom.querySelector('.input-max').setAttribute('data-max', res2);
                })
            })
        }
    }

    function isMetaMaskInstalled() {
        var ethereum = window.ethereum;
        return Boolean(ethereum && ethereum.isMetaMask)
    }

    function bindProviderEvent(provider) {
        provider.on('connect', handleConnect)
        provider.on('disconnect', handleDisconnect)
        provider.on('accountsChanged', handleAccountsChanged);
        provider.on('chainChanged', handleChainChanged);
        provider.on('message', handleMessage);
    }

    function showState(address) {
        var walletFeatureBtn = document.getElementById('WalletFeature');
        walletFeatureBtn.innerText = showAddress(address);
        walletFeatureBtn.style.display = 'block';
        var walletInfo = document.getElementById('WalletInfo');

        if (window.provider.isMetaMask) {
            var showTxt = 'Metamask';
            address = window.provider.selectedAddress;
            walletInfo.querySelector('.info').innerText = '链接至 ' + showTxt;
            walletInfo.querySelector('.address-info .address').innerText = showAddress(address);
            walletInfo.querySelector('.address-info .address').setAttribute('data-address', address)
            var identiconBig = walletInfo.querySelector('#IdenticonBig');
            identiconBig.innerHTML = '';
            identiconBig.appendChild(getIdenticon(address, 28));
            window.connectState = true;
            document.getElementById('ConnectBtn').style.display = 'none'
            showTips('info', '钱包已经连接至 ' + showTxt);
        }
        if (window.provider.isWalletConnect) {
            var showTxt = 'Walletconnect';
            walletInfo.querySelector('.info').innerText = '链接至 ' + showTxt;
            walletInfo.querySelector('.address-info .address').innerText = showAddress(address);
            walletInfo.querySelector('.address-info .address').setAttribute('data-address', address)
            var identiconBig = walletInfo.querySelector('#IdenticonBig');
            var img = document.createElement('img');
            img.setAttribute('src', './image/walletconnect.png');
            identiconBig.innerHTML = '';
            identiconBig.appendChild(img);
            window.connectState = true;
            document.getElementById('ConnectBtn').style.display = 'none'
            showTips('info', '钱包已经连接至 ' + showTxt);
        }
        var btns = document.querySelectorAll('.unlock-btn');
        for (var i = 0; i < btns.length; i++) {
            btns[i].style.display = 'none'
        }
        for (var e in window.pool_info) {
            checkPoolForUser(Number(e), window.pool_info[e]);
        }
    }

    function ConnectWallet(accounts) {
        console.log('ConnectWallet', accounts)
        if (window.provider.chainId !== '0x42' && window.provider.chainId !== 66) {
            console.log('chian id error')
            showTips('warn', '请切换网络至 OKExChain mainnet');
            userDisconnect();
            document.getElementById('SelectWallet').style.display = 'none';
            return
        }
        if (window.provider.isMetaMask) {
            window.provider
                .request({method: 'eth_requestAccounts'})
                .then(function (wallets) {
                    showState(wallets[0])
                })
                .catch((err) => {
                    if (err.code === 4001) {
                        console.log('Please connect to MetaMask.');
                        showTips('error', '用户主动拒绝链接钱包');
                    } else {
                        console.error(err);
                    }
                });
        } else {
            showState(accounts[0])
        }
        document.querySelector('#SelectWallet').style.display = 'none';

    }

    function setNetwork() {
        window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
                chainId: '0x42',
                chainName: 'OKExChain Mainnet',
                nativeCurrency: {name: 'OKExChain Token', symbol: 'OKT', decimals: 18},
                rpcUrls: [rpc],
                blockExplorerUrls: ['https://www.oklink.com/okexchain/']
            }],
        });
    }

    function installMetamask() {
        const onboarding = new MetaMaskOnboarding({forwarderOrigin: '/'});
        showTips('info', '需要安装Metamask');
        onboarding.startOnboarding();
    }

    function handleAccountsChanged(accounts) {
        if (!window.provider) {
            return
        }
        if (!accounts.length) {
            document.getElementById('WalletFeature').innerText = '';
            document.getElementById('WalletFeature').style.display = 'none';
            handleDisconnect();
            return
        }
        document.getElementById('WalletFeature').innerText = showAddress(accounts[0]);
        document.getElementById('WalletFeature').style.display = 'block'
        console.log('[handleAccountsChanged]', accounts)
        showState(accounts[0]);
    }

    function handleChainChanged(chainId) {
        console.log(chainId);
        if (window.provider.chainId !== '0x42' && window.provider.chainId !== 66) {
            console.log('chian id error')
            showTips('warn', '请切换网络至 OKExChain Mainnet');
            userDisconnect();
            document.getElementById('SelectWallet').style.display = 'none';
        }
    }

    function handleDisconnect(error) {
        if (error) {
            console.error(error)
        }
        document.getElementById('WalletFeature').innerText = '';
        document.getElementById('WalletFeature').style.display = 'none';
        document.getElementById('WalletInfo').style.display = 'none';

    }

    function handleConnect(ConnectInfo) {
        console.log('handleConnect', ConnectInfo)
    }

    function handleMessage(message) {
        console.log(message.type);
        console.log(message.data);
        //showTips('info',message.type);
    }

    function userDisconnect() {
        if (window.provider.isWalletConnect) {
            window.providers.Walletconnect.disconnect();
        }
        if (window.provider.isMetaMask) {
            handleDisconnect();
        }
        var pool_items = document.querySelectorAll('.pool-item');
        window.connectState = false;
        document.getElementById('ConnectBtn').style.display = 'block'
        for (var i = 0; i < pool_items.length; i++) {
            pool_items[i].querySelector('.withdraw-btn').style.display = 'none';
            pool_items[i].querySelector('.deposit-btn').style.display = 'none';
            pool_items[i].querySelector('.approve-btn').style.display = 'none';
            pool_items[i].querySelector('.earn-amount').innerText = '0.000';
            pool_items[i].querySelector('.my-deposit').innerText = '0.000';
            pool_items[i].querySelector('.unlock-btn').style.display = 'block';
        }

        showTips('info', '已经断开钱包连接，如需执行交易请再次连接。');
    }

    function initializeProvider() {
        if (isMetaMaskInstalled()) {
            window.providers.Metamask = window.ethereum;
            bindProviderEvent(window.providers.Metamask);
        }
        if (window.walletconnect) {
            window.providers.Walletconnect = new window.walletconnect({
                chainId: 66,
                rpc: {
                    66: "https://exchainrpc.okex.org",
                },
            });
            bindProviderEvent(window.providers.Walletconnect);
        }
    }

    function selectProvider() {
        if (this.id === 'Metamask') {
            if (!window.providers.Metamask) {
                installMetamask();
            } else {
                window.provider = window.providers.Metamask;
                ConnectWallet();
            }
        }
        if (this.id === 'Walletconnect') {
            window.providers.Walletconnect.enable()
                .then(function (wallets) {
                    window.provider = window.providers.Walletconnect;
                    ConnectWallet(wallets);
                })
                .catch(function (err) {
                    window.providers.Walletconnect = new window.walletconnect({
                        chainId: 66,
                        rpc: {
                            66: "https://exchainrpc.okex.org",
                        },
                    })
                    bindProviderEvent(window.providers.Walletconnect);
                    console.error(err);
                })
        }
    }

    function initialize() {
        //setNetwork();
        initializeProvider();
        getPool();
        autoUpdatePool();
        document.getElementById('ConnectBtn').onclick = toggleSelectWindow;
        document.querySelector('#SelectWallet .sell').onclick = toggleSelectWindow;
        document.getElementById('Metamask').onclick = selectProvider;
        document.getElementById('Walletconnect').onclick = selectProvider;
        document.getElementById('WalletFeature').onclick = toggleWalletInfoWindow;
        document.querySelector('#WalletInfo .sell').onclick = toggleWalletInfoWindow;
        document.querySelector('#WalletInfo .change-wallet').onclick = toggleSelectWindow;
        document.querySelector('#WalletInfo .disconnect').onclick = userDisconnect;
        document.querySelector('#WalletInfo .copy-address').onclick = copyAddress;
        document.querySelector('#WithdrawAction .shell').onclick = toggleWithdrawWindow;
        document.querySelector('#WithdrawAction .actions .cancel').onclick = toggleWithdrawWindow;
        document.querySelector('#DepositAction .shell').onclick = toggleDepositWindow;
        document.querySelector('#DepositAction .actions .cancel').onclick = toggleDepositWindow;
        document.querySelector('#WithdrawAction .ok').onclick = withdrawToken;
        document.querySelector('#DepositAction .ok').onclick = depositToken;
        document.querySelector('#WalletInfo .go-to-explorer').onclick = function () {
            goToExplorer();
        };

        var pool_item_list = document.querySelectorAll('.pool-item');
        for (var i = 0; i < pool_item_list.length; i++) {
            pool_item_list[i].querySelector('.approve-btn').onclick = function () {
                if (!window.connectState) {
                    toggleSelectWindow()
                } else {
                    var pid = this.parentNode.parentNode.getAttribute('data-pool').split('pool')[1]
                    approveToken(pid, pool_info[pid]['token'])
                }
            };
            pool_item_list[i].querySelector('.check-pool').onclick = function () {
                window.open("https://www.oklink.com/okexchain/address/" + factoryAddress);
            };
            pool_item_list[i].querySelector('.withdraw-btn').onclick = function () {
                var pid = this.parentNode.parentNode.getAttribute('data-pool').split('pool')[1]
                toggleWithdrawWindow(Number(pid));
            };
            pool_item_list[i].querySelector('.deposit-btn').onclick = function () {
                var pid = this.parentNode.parentNode.getAttribute('data-pool').split('pool')[1]
                toggleDepositWindow(Number(pid))
            };
            pool_item_list[i].querySelector('.unlock-btn').onclick = toggleSelectWindow;
        }

        document.querySelector('#WithdrawAction .num_input').oninput = function (e) {
            console.log('e.keyCode', isNaN(this.value))
            if (isNaN(this.value)) {
                this.value = window.input_history;
            } else {
                window.input_history = this.value;
            }
            if (this.value && Number(this.value) !== 0) {
                this.parentNode.parentNode.querySelector('.ok').setAttribute('class', 'actions-item ok');
            } else {
                this.parentNode.parentNode.querySelector('.ok').setAttribute('class', 'actions-item ok disabled');
            }
        }
        document.querySelector('#WithdrawAction .input-max').onclick = function () {
            var numMax = this.getAttribute('data-max');
            if (numMax && numMax !== '0') {
                document.querySelector('#WithdrawAction .num_input').value = new BigNumber(numMax).dividedBy(1e18).toFormat();
                this.parentNode.parentNode.querySelector('.ok').setAttribute('class', 'actions-item ok');
            }
        };
        document.querySelector('#DepositAction .num_input').oninput = function (e) {
            if (isNaN(this.value)) {
                this.value = window.input_history;
            } else {
                window.input_history = this.value;
            }
            if (this.value && Number(this.value) !== 0) {
                var approve = document.querySelector('#DepositAction .input-max').getAttribute('data-approve-amount');
                var max_amount = document.querySelector('#DepositAction .input-max').getAttribute('data-max');
                if (new BigNumber(this.value).multipliedBy(1e18).isGreaterThan(max_amount)) {
                    this.parentNode.parentNode.querySelector('.ok').setAttribute('class', 'actions-item ok disabled');
                } else {
                    this.parentNode.parentNode.querySelector('.ok').setAttribute('class', 'actions-item ok');
                }
                if (new BigNumber(this.value).multipliedBy(1e18).isGreaterThan(approve)) {
                    this.parentNode.parentNode.querySelector('.ok').style.display = 'none';
                    this.parentNode.parentNode.querySelector('.approve').style.display = 'block';
                } else {
                    this.parentNode.parentNode.querySelector('.ok').style.display = 'block';
                    this.parentNode.parentNode.querySelector('.approve').style.display = 'none';
                }
            } else {
                this.parentNode.parentNode.querySelector('.ok').setAttribute('class', 'actions-item ok disabled');
                this.parentNode.parentNode.querySelector('.ok').style.display = 'block';
                this.parentNode.parentNode.querySelector('.approve').style.display = 'none';

            }
        }
        document.querySelector('#DepositAction .input-max').onclick = function () {
            var numMax = this.getAttribute('data-max');
            if (numMax && numMax !== '0') {
                document.querySelector('#DepositAction .num_input').value = new BigNumber(numMax).dividedBy(1e18).toFormat();
                var approve = document.querySelector('#DepositAction .input-max').getAttribute('data-approve-amount');
                if (new BigNumber(numMax).isGreaterThan(approve)) {
                    this.parentNode.parentNode.querySelector('.ok').style.display = 'none';
                    this.parentNode.parentNode.querySelector('.approve').style.display = 'block';
                } else {
                    this.parentNode.parentNode.querySelector('.ok').style.display = 'block';
                    this.parentNode.parentNode.querySelector('.approve').style.display = 'none';
                }
                this.parentNode.parentNode.querySelector('.ok').setAttribute('class', 'actions-item ok');
            }
        };

        document.querySelector('#DepositAction .approve').onclick = function () {
            var pid = document.querySelector('#DepositAction').getAttribute('data-poolid');
            this.setAttribute('class', 'actions-item approve disabled');
            this.innerText = '批准中';
            approveToken(Number(pid), window.pool_info[pid]['token'], function (approve_amount) {
                document.querySelector('#DepositAction .input-max').setAttribute('data-approve-amount', approve_amount);
                document.querySelector('#DepositAction .ok').setAttribute('class', 'actions-item ok');
                document.querySelector('#DepositAction .ok').style.display = 'block';
                document.querySelector('#DepositAction .approve').style.display = 'none';
                document.querySelector('#DepositAction .approve').setAttribute('class', 'actions-item approve');
                document.querySelector('#DepositAction .approve').innerText = '批准';
            })
        };
    }

    function autoUpdatePool() {
        setTimeout(function () {
            getPool(function (id, pool_info) {
                checkPoolForUser(id, pool_info);
            }, true);
            autoUpdatePool();
        }, 3000)

    }

    window.addEventListener('DOMContentLoaded', initialize);
</script>
</html>